platform: linux

image_resource:
  type: docker-image
  source:
    repository: rexdb/build
    tag: 2019.11.12

inputs:
- name: codebase

params:
  CI: "true"
  CONTINUOUS_INTEGRATION: "true"

run:
  path: /bin/sh
  args:
  - -exc
  - |
    apt-get update
    apt-get install --yes postgresql redis
    service postgresql start
    su - postgres -c 'createuser -s root'
    sed -i 's/bind 127.0.0.1 ::1/bind 127.0.0.1/' /etc/redis/redis.conf
    service redis-server start
    make init-local
    ./bin/pip list --format=legacy
    make test
  dir: codebase
