*****************
  ``rex`` Tasks
*****************

.. contents:: Table of Contents


``rex serve``
=============

To start a development HTTP server, you can use ``rex serve`` task::

    >>> from rex.ctl import Ctl, ctl

    >>> serve_ctl = Ctl("serve rex.web_demo")

The server starts at http://localhost:8080/.  We can now make a request::

    >>> import urllib, time

    >>> def get(path, port=8080):
    ...     tries = 0
    ...     while tries < 100:
    ...         try:
    ...             return urllib.urlopen('http://localhost:%s%s' % (port, path)).read()
    ...         except IOError:
    ...             tries += 1
    ...             time.sleep(0.1)

    >>> print get('/ping')
    PONG!

We can stop the server and display the accumulated output::

    >>> print serve_ctl.stop()      # doctest: +NORMALIZE_WHITESPACE, +ELLIPSIS
    Serving rex.web_demo on 127.0.0.1:8080
    localhost - - [...] "GET /ping HTTP/1.0" 200 5

To set the server address, use parameters ``--host`` and ``--port``::

    >>> serve_ctl = Ctl("serve rex.web_demo -h 127.0.0.1 -p 8088")

    >>> print get('/ping', port=8088)
    PONG!

    >>> print serve_ctl.stop()      # doctest: +NORMALIZE_WHITESPACE, +ELLIPSIS
    Serving rex.web_demo on 127.0.0.1:8088
    localhost - - [...] "GET /ping HTTP/1.0" 200 5

The server reports unhandled exceptions::

    >>> serve_ctl = Ctl("serve rex.web_demo")

    >>> print get('/error')         # doctest: +NORMALIZE_WHITESPACE, +ELLIPSIS
    A server error occurred.  Please contact the administrator.

    >>> print serve_ctl.stop()      # doctest: +NORMALIZE_WHITESPACE, +ELLIPSIS
    Serving rex.web_demo on 127.0.0.1:8080
    ----------------------------------------------------------------------
    [...] localhost => http://localhost:8080/error
    Traceback (most recent call last):
      ...
    RuntimeError: some unexpected problem occurred
    localhost - - [...] "GET /error HTTP/1.0" 500 59

If ``--debug`` is enabled, the exception traceback is displayed
in the response::

    >>> serve_ctl = Ctl("serve rex.web_demo --debug")

    >>> print get('/error')         # doctest: +NORMALIZE_WHITESPACE, +ELLIPSIS
    A server error occurred.  Please contact the administrator.
    <BLANKLINE>
    [...] localhost => http://localhost:8080/error
    Traceback (most recent call last):
      ...
    RuntimeError: some unexpected problem occurred

    >>> print serve_ctl.stop()      # doctest: +NORMALIZE_WHITESPACE, +ELLIPSIS
    Serving rex.web_demo on 127.0.0.1:8080
    ----------------------------------------------------------------------
    [...] localhost => http://localhost:8080/error
    Traceback (most recent call last):
      ...
    RuntimeError: some unexpected problem occurred
    localhost - - [...] "GET /error HTTP/1.0" 500 1595

Use option ``--remote-user`` to set user credentials for all HTTP queries::

    >>> serve_ctl = Ctl("serve rex.web_demo --remote-user=Alice")

    >>> print get('/')              # doctest: +NORMALIZE_WHITESPACE, +ELLIPSIS
    <!DOCTYPE html>
    <title>Welcome to REX.WEB_DEMO!</title>

    >>> print serve_ctl.stop()      # doctest: +NORMALIZE_WHITESPACE, +ELLIPSIS
    Serving rex.web_demo on 127.0.0.1:8080
    localhost - Alice [...] "GET / HTTP/1.0" 200 55

Use option ``--watch`` to automatically rebuild generated files; option
``--quiet`` to suppress the output::

    >>> serve_ctl = Ctl("serve rex.web_demo --watch --quiet")

    >>> print get('/')              # doctest: +NORMALIZE_WHITESPACE, +ELLIPSIS
    <!DOCTYPE html>
    <title>Welcome to REX.WEB_DEMO!</title>

    >>> print serve_ctl.stop()      # doctest: +NORMALIZE_WHITESPACE, +ELLIPSIS


``rex wsgi``
============

Use command ``rex wsgi`` to generate a WSGI file::

    >>> ctl("wsgi rex.web_demo --debug")    # doctest: +NORMALIZE_WHITESPACE
    # WSGI script for the `rex.web_demo` application.
    # Use it with `uwsgi`, `mod_wsgi` or any other WSGI container.
    <BLANKLINE>
    from rex.core import Rex
    <BLANKLINE>
    requirements = [
        'rex.web_demo',
    ]
    <BLANKLINE>
    parameters = {
        'debug': True,
    }
    <BLANKLINE>
    application = Rex(*requirements, **parameters)

You can use option ``--output`` to save the output to a file::

    >>> ctl("wsgi rex.web_demo -o ./build/sandbox/web_demo.wsgi")   # doctest: +NORMALIZE_WHITESPACE

    >>> print open("./build/sandbox/web_demo.wsgi").read()      # doctest: +NORMALIZE_WHITESPACE, +ELLIPSIS
    # WSGI script for the `rex.web_demo` application.
    # Use it with `uwsgi`, `mod_wsgi` or any other WSGI container.
    ...


``rex serve-uwsgi``
===================

To run a RexDB application under uWSGI server, use ``rex serve-uwsgi`` command.  Use
option ``--watch`` to rebuild autogenerated files on the fly::

    >>> serve_uwsgi_ctl = Ctl("serve-uwsgi rex.web_demo --watch"
    ...                       " --set-uwsgi need-app --set-uwsgi http-socket=:8080")

Now you could make HTTP requests::

    >>> print get('/ping')
    PONG!

You can stop the server by pressing Ctrl-C::

    >>> print serve_uwsgi_ctl.stop()                # doctest: +ELLIPSIS
    Starting uWSGI server for rex.web_demo
    *** Starting uWSGI ... ***
    ...

If uWSGI configuration is not provided, an error is reported::

    >>> ctl("serve-uwsgi rex.web_demo", expect=1)   # doctest: +NORMALIZE_WHITESPACE
    FATAL ERROR: missing uWSGI configuration


``rex start``, ``rex stop``, ``rex status``
===========================================

You can use ``rex start`` command to run uWSGI in daemon mode::

    >>> ctl("start rex.web_demo"
    ...     " --set-uwsgi http-socket=:8080"
    ...     " --set-uwsgi auto-procname")           # doctest: +NORMALIZE_WHITESPACE, +ELLIPSIS
    Starting rex.web_demo (http-socket: :8080, logto: /.../rex.web_demo.log)

You can now query the server::

    >>> print get('/ping')
    PONG!

``rex start`` will complain if the server is already running::

    >>> ctl("start rex.web_demo", expect=1)         # doctest: +NORMALIZE_WHITESPACE
    FATAL ERROR: rex.web_demo is already running

Use ``rex status`` command to get the status of the uWSGI daemon::

    >>> ctl("status rex.web_demo")                  # doctest: +NORMALIZE_WHITESPACE, +ELLIPSIS
    rex.web_demo is running (http-socket: :8080, logto: /.../rex.web_demo.log)

You can also use ``rex status`` command to report the PID of the server and the
path to the log file::

    >>> pid_ctl = Ctl("status rex.web_demo --pid")
    >>> pid = int(pid_ctl.wait())

    >>> log_ctl = Ctl("status rex.web_demo --log")
    >>> log = open(log_ctl.wait().strip())
    >>> print log.name                              # doctest: +NORMALIZE_WHITESPACE, +ELLIPSIS
    /.../rex.web_demo.log

Use ``rex stop`` command to stop the server::

    >>> ctl("stop rex.web_demo")                    # doctest: +NORMALIZE_WHITESPACE, +ELLIPSIS
    Stopping rex.web_demo (http-socket: :8080, logto: /.../rex.web_demo.log)

``rex stop`` will fail if the server is not running::

    >>> ctl("stop rex.web_demo", expect=1)          # doctest: +NORMALIZE_WHITESPACE
    FATAL ERROR: rex.web_demo is not running

``rex status`` will report if the server is not running::

    >>> ctl("status rex.web_demo")                  # doctest: +NORMALIZE_WHITESPACE
    rex.web_demo is not running

It is an error to start uWSGI with invalid configuration or without any socket
configuration::

    >>> ctl("start rex.web_demo"
    ...     " --set-uwsgi http-socket=/path/to/socket", expect=1)   # doctest: +NORMALIZE_WHITESPACE, +ELLIPSIS
    Starting rex.web_demo (http-socket: /path/to/socket, logto: /.../rex.web_demo.log)
    [uWSGI] getting YAML configuration from /.../rex.web_demo.yaml
    ...
    FATAL ERROR: non-zero exit code: uwsgi /.../rex.web_demo.yaml

    >>> ctl("start rex.web_demo", expect=1)         # doctest: +NORMALIZE_WHITESPACE
    FATAL ERROR: uWSGI sockets are not configured

If you use a non-default configuration file, the file name is used
for identifying the server::

    >>> open('./build/sandbox/web_demo.yaml', 'w').write('''
    ... project: rex.web_demo
    ... uwsgi:
    ...   http-socket: :8088
    ... ''')

    >>> ctl("start --config=./build/sandbox/web_demo.yaml")         # doctest: +ELLIPSIS
    Starting rex.web_demo (http-socket: :8088, logto: /.../rex.web_demo-web_demo.log)

If the YAML file containing state information is corrupted, the error
is silently ignored::

    >>> status_ctl = Ctl("status --config=./build/sandbox/web_demo.yaml --log")
    >>> cfg = open(status_ctl.wait().strip().replace('.log', '.yaml'), 'w')
    >>> cfg.write("'")
    >>> cfg.close()

    >>> ctl("status --config=./build/sandbox/web_demo.yaml")        # doctest: +ELLIPSIS
    rex.web_demo is running (logto: /.../rex.web_demo-web_demo.log)

    >>> ctl("stop --config=./build/sandbox/web_demo.yaml")          # doctest: +ELLIPSIS
    Stopping rex.web_demo (logto: /.../rex.web_demo-web_demo.log)


