#
# Copyright (c) 2013, Prometheus Research, LLC
#

title: REX.CTL Tests
suite: rex.ctl
tests:


# Setup a sandbox for `rex` invocations.
- rmdir: ./sandbox
- mkdir: ./sandbox
- sh: ln -s ../test/rex-helper ./sandbox/rex

- coverage: setup.cfg

- sh: pip install -q -e ./demo/rex.ctl_demo


#
# python -m rex.ctl
#

- title: python -m rex.ctl
  tests:
  - py: |
      # Simulate `python -m rex.ctl` invocation
      import sys
      old_argv = sys.argv
      sys.argv = ['__main__.py']
      try:
          import rex.ctl.__main__
      except SystemExit:
          pass
      sys.argv = old_argv
      # Save coverage trace.
      if '__coverage__' in __pbbt__:
          __pbbt__['__coverage__'].stop()
          __pbbt__['__coverage__'].save()


#
# rex help
#

- title: rex help
  tests:
  - sh: ./sandbox/rex
  - sh: ./sandbox/rex help
  - sh: ./sandbox/rex help serve
  - sh: ./sandbox/rex help wsgi
  - sh: ./sandbox/rex help http-host
  - sh: ./sandbox/rex help http-port
  - sh: ./sandbox/rex help project
  - sh: ./sandbox/rex help requirements
  - sh: ./sandbox/rex help parameters


#
# rex serve
#

- title: rex serve
  tests:

  - title: Run with no project
    tests:
    - sh: ./sandbox/rex --daemon serve
    - sh: ./sandbox/rex --get /
      ignore: &http-ignore |
        ^Date:.(.*)$ |
        ^Server:.(.*)$ |
        ^Last-Modified:.(.*)$ |
        \[(\d\d\d\d)-(\d\d)-(\d\d).(\d\d):(\d\d):(\d\d)\.(\d+)\] |
        Traceback.\(most.recent.call.last\): ((?:[\n][ ]+.+)+)
    - sh: ./sandbox/rex --kill serve
      ignore: &log-ignore |
        \[(\d\d)/(\w\w\w)/(\d\d\d\d).(\d\d):(\d\d):(\d\d)\] |
        \[(\d\d\d\d)-(\d\d)-(\d\d).(\d\d):(\d\d):(\d\d)\.(\d+)\] |
        [ ](\d+)$ |
        Traceback.\(most.recent.call.last\): ((?:[\n][ ]+.+)+)

  - title: Run with a project
    tests:
    - sh: ./sandbox/rex --daemon serve rex.ctl_demo
    - sh: ./sandbox/rex --get /
      ignore: *http-ignore
    - sh: ./sandbox/rex --kill serve rex.ctl_demo
      ignore: *log-ignore

  - title: Using `--require` option
    tests:
    - sh: ./sandbox/rex --daemon serve rex.ctl_demo --require ../test/data/shared/
    - sh: ./sandbox/rex --get /
      ignore: *http-ignore
    - sh: ./sandbox/rex --get /shared/shared.css
      ignore: *http-ignore
    - sh: ./sandbox/rex --kill serve rex.ctl_demo --require ../test/data/shared/
      ignore: *log-ignore

  - title: Using `--set` option
    tests:
    - sh: ./sandbox/rex --daemon serve rex.ctl_demo --set hello_access=anybody
    - sh: ./sandbox/rex --get /hello
      ignore: *http-ignore
    - sh: ./sandbox/rex --kill serve rex.ctl_demo --set hello_access=anybody
      ignore: *log-ignore

  - title: Invalid requirement or parameter
    tests:
    - sh: ./sandbox/rex serve rex.ctl_demo --require unknown-package
      exit: 1
    - sh: ./sandbox/rex serve rex.ctl_demo --set unknown-parameter=true
      exit: 1

  - title: Server address with `--http-host` and `--http-port`
    tests:
    - sh: ./sandbox/rex --daemon
            --http-host=localhost --http-port=8088 serve rex.ctl_demo
    - sh: ./sandbox/rex --get http://localhost:8088/
      ignore: *http-ignore
    - sh: ./sandbox/rex --kill
            --http-host=localhost --http-port=8088 serve rex.ctl_demo
      ignore: *log-ignore

  - title: Server address with `--host` and `--port`
    tests:
    - sh: ./sandbox/rex --daemon
            --http-host=localhost --http-port=8088 serve rex.ctl_demo -h 127.0.0.1 -p 8080
    - sh: ./sandbox/rex --get /
      ignore: *http-ignore
    - sh: ./sandbox/rex --kill
            --http-host=localhost --http-port=8088 serve rex.ctl_demo -h 127.0.0.1 -p 8080
      ignore: *log-ignore

  - title: Invalid `--http-host` and `--http-port`
    tests:
    - write: ./sandbox/rex.yaml
      data: 'http-host: true'
    - sh: ./sandbox/rex serve
      exit: 1
    - write: ./sandbox/rex.yaml
      data: 'http-host: 256.56.6.0'
    - sh: ./sandbox/rex serve
      exit: 1
    - write: ./sandbox/rex.yaml
      data: 'http-port: -1'
    - sh: ./sandbox/rex serve
      exit: 1
    - write: ./sandbox/rex.yaml
      data: 'http-port: localhost'
    - sh: ./sandbox/rex serve
      exit: 1
    - write: ./sandbox/rex.yaml
      data: 'http-port: 15.31'
    - sh: ./sandbox/rex serve
      exit: 1
    - write: ./sandbox/rex.yaml
      data: 'http-port: 80'
    - sh: ./sandbox/rex serve
      exit: 1
    - rm: ./sandbox/rex.yaml

  - title: HTTP Auth
    tests:
    - sh: ./sandbox/rex --daemon serve rex.ctl_demo
    - sh: ./sandbox/rex --get http://Aladdin@localhost:8080/
      ignore: *http-ignore
    - sh: ./sandbox/rex --get http://Aladdin:open%20sesame@localhost:8080/
      ignore: *http-ignore
    - sh: ./sandbox/rex --kill serve rex.ctl_demo
      ignore: *log-ignore

  - title: Unhandled exceptions
    tests:
    - sh: ./sandbox/rex --daemon serve rex.ctl_demo
    - sh: ./sandbox/rex --get /
      ignore: *http-ignore
    - sh: ./sandbox/rex --get /error
      ignore: *http-ignore
    - sh: ./sandbox/rex --kill serve rex.ctl_demo
      ignore: *log-ignore

  - title: Unhandled exceptions with `--debug`
    tests:
    - sh: ./sandbox/rex --daemon serve rex.ctl_demo --debug
    - sh: ./sandbox/rex --get /
      ignore: *http-ignore
    - sh: ./sandbox/rex --get /error
      ignore: *http-ignore
    - sh: ./sandbox/rex --kill serve rex.ctl_demo --debug
      ignore: *log-ignore

  - title: Handling invalid requests
    tests:
    - sh: ./sandbox/rex --daemon serve rex.ctl_demo --debug
    - sh: ./sandbox/rex --get '/invalid /request'
      ignore: *http-ignore
    - sh: ./sandbox/rex --kill serve rex.ctl_demo --debug
      ignore: *log-ignore

  - title: Using `--quiet` option
    tests:
    - sh: ./sandbox/rex --daemon serve rex.ctl_demo --quiet
    - sh: ./sandbox/rex --get /
      ignore: *http-ignore
    - sh: ./sandbox/rex --get /error
      ignore: *http-ignore
    - sh: ./sandbox/rex --kill serve rex.ctl_demo --quiet
      ignore: *log-ignore


#
# rex wsgi
#

- title: rex wsgi
  tests:

  - title: Requirements and parameters
    tests:
    - sh: ./sandbox/rex wsgi
    - sh: ./sandbox/rex wsgi rex.ctl_demo
    - sh: ./sandbox/rex wsgi rex.ctl_demo --require ../test/data/shared/
    - sh: ./sandbox/rex wsgi rex.ctl_demo --set hello_access=anybody
    - sh: ./sandbox/rex wsgi rex.ctl_demo --require unknown-package
      exit: 1
    - sh: ./sandbox/rex wsgi rex.ctl_demo --set unknown-parameter=true
      exit: 1

  - title: Using `--output` option
    tests:
    - sh: ./sandbox/rex wsgi rex.ctl_demo -o ctl_demo.wsgi
    - read: ./sandbox/ctl_demo.wsgi
    - rm: ./sandbox/ctl_demo.wsgi


#
# rex help packages
#

- title: rex help packages
  tests:

  - title: Run with no project
    tests:
    - sh: ./sandbox/rex help packages
      ignore: &ignore-packages |
        ^Version: \s+ (\d+\.\d+\.\d+)$ |
        ^(?:Location|Resources): \s+ /(.+)$ |
        ^Summary: \s+ (.*)$ |
        ^Dependencies: ((?:[\n]+[ ]+.+)+)

  - title: Run with a project
    tests:
    - sh: ./sandbox/rex help packages --project rex.ctl_demo
      ignore: *ignore-packages
    - sh: ./sandbox/rex help packages --requirements rex.ctl_demo
      ignore: *ignore-packages
    - sh: ./sandbox/rex help packages --requirements '["rex.ctl_demo"]'
      ignore: *ignore-packages

  - title: Module and static requirements
    tests:
    - sh: ./sandbox/rex help packages --requirements rex.core.application
      ignore: *ignore-packages
    - sh: ./sandbox/rex help packages --requirements ../test/data/shared/
      ignore: *ignore-packages

  - title: Ill-formed requirements
    tests:
    - sh: ./sandbox/rex help packages --project rex.unknown
      exit: 1
    - write: ./sandbox/rex.yaml
      data: 'project: true'
    - sh: ./sandbox/rex help packages
      exit: 1
    - write: ./sandbox/rex.yaml
      data: 'requirements: [true]'
    - sh: ./sandbox/rex help packages
      exit: 1
    - rm: ./sandbox/rex.yaml


#
# rex help settings
#

- title: rex help settings
  tests:

  - title: Run with no project
    tests:
    - sh: ./sandbox/rex help settings
      ignore: &ignore-settings |
        ^Description: ((?:[\n]+[ ]+.+)+)

  - title: Run with a project and parameters
    tests:
    - sh: ./sandbox/rex help settings --project rex.ctl_demo
      ignore: *ignore-settings
    - sh: ./sandbox/rex help settings --project rex.ctl_demo
            --parameters 'debug hello_access=anybody'
      ignore: *ignore-settings
    - sh: ./sandbox/rex help settings --project rex.ctl_demo
            --parameters '{"debug":true,"hello_access":"anybody"}'
      ignore: *ignore-settings

  - title: Ill-formed parameters
    tests:
    - sh: ./sandbox/rex help settings --project rex.unknown
      exit: 1
    - sh: ./sandbox/rex help settings --project ../test/data/ill_formed_setting/
      ignore: *ignore-settings
    - sh: ./sandbox/rex help settings --project ../test/data/broken_setting/
      ignore: *ignore-settings
    - write: ./sandbox/rex.yaml
      data: 'parameters: [true]'
    - sh: ./sandbox/rex help settings
      exit: 1
    - rm: ./sandbox/rex.yaml


- sh: pip uninstall -q -y rex.ctl_demo

- py: |
    # Load accumulated coverage data
    if '__coverage__' in __pbbt__:
        __pbbt__['__coverage__'].load()

- coverage-check: 95.0
- coverage-report: ./build/coverage

- rmdir: sandbox


