include:
- base.yaml
paths:

  /individuals/make:
    access: anybody
    action:
      type: make
      entity: individual
#     query: |
#       /do(
#         $id := insert(individual := { code := $code, sex := $sex }),
#         { id := $id }
#       )
      fields:
      - column:
        - code
        - sex

  /individuals/view:
    access: anybody
    action:
      type: view
      entity: individual
      fields:
      - code
      - identity.givenname
      - identity.surname
      - sex


  /individuals/edit:
    access: anybody
    action:
      type: wizard
      title: Individuals Edit
      path:
      - edit-individual:
        - view-individual:
        - drop-individual:

      actions:
        view-individual: /individuals/view
        drop-individual:
          type: drop
          entity: individual[x]
        edit-individual:
          type: edit
          entity: individual
          fields:
          - code
          - sex
          query: |
            /do(
              $id := update(individual := { code := $code, sex := $sex }),
              { id := $id }
            )

      states:
        individual:
          x:
            title: Super
            expression: id() = 'A11Z1814'

  /:
    access: anybody
    action:
      type: wizard
      path:
      - plab:
      - pick-make-individual:
        - drop-individual:
        - view-individual:
        - edit-individual:
      - pick-lab:
        - view-lab:
      actions:
        plab:
          type: pick
          entity: lab
          fields:
          - code
          - title
        pick-lab: /labs/pick
        view-lab: /labs/view
        pick-make-individual: /individuals/pick-make
        view-individual: /individuals/view?individual=individual[super]
        edit-individual: /individuals/edit
        drop-individual:
          type: drop
          entity: individual

      states:
        individual:
          super:
            title: Super
            expression: id() = 'A11Z1814'

  /@/plab: !override
    fields:
    - code

  /@/view-lab: !override
    fields:
    - value_key: code
      label: CODE

  /labs/pick: !override
    fields:
    - code

  /individuals/pick-make/@/pick-individual: !override
    fields:
    - code
