paths:

  /labs/pick:
    access: anybody
    action:
      type: pick
      entity: lab

  /labs/view:
    access: anybody
    action:
      type: view
      entity: lab

  /individuals/make:
    access: anybody
    action:
      type: make
      entity: individual
#     query: |
#       /do(
#         $id := insert(individual := { code := $code, sex := $sex }),
#         { id := $id }
#       )
      fields:
      - column:
        - code
        - sex

  /individuals/view:
    access: anybody
    action:
      type: view
      entity: individual
      fields:
      - code
      - identity.givenname
      - identity.surname
      - sex

  /individuals/pick-make:
    access: anybody
    action:
      type: wizard
      title: Individuals
      path:
      - pick-individual:
      - make-individual:
        - replace: ../pick-individual
      actions:
        make-individual: /individuals/make
        view-individual: /individuals/view
        view-lab: /labs/view
        pick-lab: /labs/pick
        pick-individual:
          type: pick
          entity: individual
          search: code~$search
          search_placeholder: Search by code or name
          fields:
          - code
          - identity.givenname
          - identity.surname


  /individuals/edit:
    access: anybody
    action:
      type: wizard
      title: Individuals Edit
      path:
      - edit-individual:
        - view-individual:
        - drop-individual:

      actions:
        view-individual: /individuals/view
        drop-individual:
          type: drop
          entity: individual[x]
        edit-individual:
          type: edit
          entity: individual
          fields:
          - code
          - sex
          query: |
            /do(
              $id := update(individual := { code := $code, sex := $sex }),
              { id := $id }
            )

      states:
        individual:
          x:
            title: Super
            expression: id() = 'A11Z1814'

  /:
    access: anybody
    action:
      type: wizard
      path:
      - pick-make-individual:
        - drop-individual:
        - view-individual:
        - edit-individual:
      - pick-lab:
        - view-lab:
      actions:
        pick-lab: /labs/pick
        view-lab: /labs/view
        pick-make-individual: /individuals/pick-make
        view-individual: /individuals/view?individual=individual[super]
        edit-individual: /individuals/edit
        drop-individual:
          type: drop
          entity: individual

      states:
        individual:
          super:
            title: Super
            expression: id() = 'A11Z1814'


  /plots:
    access: anybody
    action:
      type: wizard

      path:
      - gender:
      - gender-pie:
      - gender-detailed:
      - pick-study:
        - gender-by-study:

      actions:

        gender:
          type: plotly
          title: Gender (Bar Chart)

          plot:
            type: bar
            name: Gender (All participant)

          query: |
            /individual^sex{sex :as x, count(^) :as y}

        gender-pie:
          type: plotly
          title: Gender (Pie Chart)

          plot:
            type: pie
            name: Gender (All participant)

          query: |
            /individual^sex{sex :as label, count(^) :as value}

        gender-detailed:
          type: plotly
          title: Gender (Bar Chart, multiple traces)

          plot:
            all:
              type: bar
              name: All
            recruited:
              type: bar
              name: Recruited
            enrolled:
              type: bar
              name: Enrolled

          query: |
            {
              all := /individual^sex{sex :as x, count(^) :as y},
              recruited := /study_recruitment^individual.sex{sex :as x, count(^) :as y},
              enrolled := /study_enrollment^individual.sex{sex :as x, count(^) :as y}
            }

        pick-study:
          type: pick
          entity: study
          fields:
          - code
          - title

        gender-by-study:
          type: plotly
          title: Gender By Study Recruitment

          input:
          - study: study

          plot:
            type: pie

          query: |
            /study_recruitment?study=$study^individual.sex{sex :as label, count(^) :as value}
