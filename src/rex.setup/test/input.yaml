#
# Copyright (c) 2012-2014, Prometheus Research, LLC
#

title: REX.SETUP
tests:

- title: Test `install` command
  suite: install
  tests:
  # Create a virtual environment, install rex.setup, prepare rex.setup_demo.
  - rmdir: sandbox
  - &create-virtualenv
    sh: virtualenv -q --system-site-packages --never-download ./sandbox
  - &install-self
    sh: ./bin/pip install -q -e ..
    cd: sandbox
  - &prepare-demo
    sh: sh -c 'mkdir ./sandbox/src; cp -a ./demo ./sandbox/src/rex.setup_demo'
  # Install rex.setup_demo; verify layout and egg-info files.
  - sh: ./bin/pip install -q ./src/rex.setup_demo
    cd: sandbox
  - read: ./sandbox/lib/python2.7/site-packages/rex.setup_demo-2.2.0-py2.7.egg-info/rex_init.txt
  - read: ./sandbox/lib/python2.7/site-packages/rex.setup_demo-2.2.0-py2.7.egg-info/rex_static.txt
    ignore: &ignore-prefix |
      /(.*)/sandbox/
  - read: ./sandbox/lib/python2.7/site-packages/rex.setup_demo-2.2.0-py2.7.egg-info/rex_bundle.txt
  - sh: ls -R ./lib/python2.7/site-packages/rex
    environ: { LC_ALL: C }
    cd: sandbox
  - sh: ls ./share/rex
    environ: { LC_ALL: C }
    cd: sandbox
  - sh: ls ./share/rex/rex.setup_demo
    environ: { LC_ALL: C }
    cd: sandbox
  - sh: ls ./share/rex/rex.setup_demo/www
    environ: { LC_ALL: C }
    cd: sandbox
  - sh: ls ./share/rex/rex.setup_demo/js
    environ: { LC_ALL: C }
    cd: sandbox
  - sh: ls ./share/rex/rex.setup_demo/js/bower_components
    environ: { LC_ALL: C }
    cd: sandbox
  # Cleanup.
  - rmdir: sandbox

- title: Test `develop` command
  suite: develop
  tests:
  # Create a virtual environment, install rex.setup, prepare rex.setup_demo.
  - *create-virtualenv
  - *install-self
  - *prepare-demo
  # Install rex.setup_demo in editable mode; verify layout and egg-info files.
  - sh: ./bin/pip install -q -e ./src/rex.setup_demo
    cd: sandbox
  - read: ./sandbox/src/rex.setup_demo/src/rex.setup_demo.egg-info/rex_init.txt
  - read: ./sandbox/src/rex.setup_demo/src/rex.setup_demo.egg-info/rex_static.txt
    ignore: *ignore-prefix
  # Verify fixup of namespace packages.
  - read: ./sandbox/lib/python2.7/site-packages/nsdev-rex.pth
  - sh: ls ./share/rex
    environ: { LC_ALL: C }
    cd: sandbox
  - sh: ls ./share/rex/rex.setup_demo
    environ: { LC_ALL: C }
    cd: sandbox
  - sh: ls ./share/rex/rex.setup_demo/www
    environ: { LC_ALL: C }
    cd: sandbox
  - sh: ls ./share/rex/rex.setup_demo/js
    environ: { LC_ALL: C }
    cd: sandbox
  - sh: ls ./share/rex/rex.setup_demo/js/bower_components
    environ: { LC_ALL: C }
    cd: sandbox
  # Cleanup.
  - rmdir: sandbox

- title: Test `sdist` command
  suite: sdist
  tests:
  # Create a virtual environment, install rex.setup, prepare rex.setup_demo.
  - *create-virtualenv
  - *install-self
  - *prepare-demo
  # Build source distribution for rex.setup_demo; verify content.
  - sh: ../../bin/python setup.py -q sdist --format=zip
    cd: ./sandbox/src/rex.setup_demo
  - sh: unzip -q ./src/rex.setup_demo/dist/rex.setup_demo-2.2.0.zip
    cd: sandbox
  - sh: ls -R ./rex.setup_demo-2.2.0
    environ: { LC_ALL: C }
    cd: sandbox
  # Cleanup.
  - rmdir: sandbox

- title: Test `bdist_wheel` command
  suite: sdist
  tests:
  # Create a virtual environment, install rex.setup, prepare rex.setup_demo.
  - *create-virtualenv
  - *install-self
  - *prepare-demo
  # Make sure `bdist_wheel` is available.
  - sh: ./bin/pip install -q wheel
    cd: sandbox
  # Build a wheel package for rex.setup_demo; install it and verify content.
  - sh: ../../bin/python setup.py -q bdist_wheel
    cd: ./sandbox/src/rex.setup_demo
  - sh: ./bin/pip install -q ./src/rex.setup_demo/dist/rex.setup_demo-2.2.0-py2-none-any.whl
    cd: sandbox
  - sh: ls ./lib/python2.7/site-packages/rex
    environ: { LC_ALL: C }
    cd: sandbox
  - sh: ls ./share/rex
    environ: { LC_ALL: C }
    cd: sandbox
  - sh: ls ./share/rex/rex.setup_demo
    environ: { LC_ALL: C }
    cd: sandbox
  - sh: ls ./share/rex/rex.setup_demo/www
    environ: { LC_ALL: C }
    cd: sandbox
  - sh: ls ./share/rex/rex.setup_demo/js
    environ: { LC_ALL: C }
    cd: sandbox
  - sh: ls ./share/rex/rex.setup_demo/js/bower_components
    environ: { LC_ALL: C }
    cd: sandbox
  # Cleanup.
  - rmdir: sandbox

