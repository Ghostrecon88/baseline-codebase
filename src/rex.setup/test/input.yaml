#
# Copyright (c) 2012-2013, Prometheus Research, LLC
#

title: REX.SETUP Tests
suite: rex.setup
tests:

- title: Test `install` command
  suite: install
  tests:
  # Create a virtual environment, install rex.setup, prepare rex.setup_demo.
  - rmdir: sandbox
  - &create-virtualenv
    sh: virtualenv -q --system-site-packages --never-download ./sandbox
  - &install-self
    sh: ./bin/pip install -q -e ..
    cd: sandbox
  - &prepare-demo
    sh: cp -a ./demo ./sandbox/src
  # Install rex.setup_demo; verify layout and egg-info files.
  - sh: ./bin/pip install -q ./src/rex.setup_demo
    cd: sandbox
  - read: ./sandbox/lib/python2.7/site-packages/rex.setup_demo-1.0-py2.7.egg-info/rex_init.txt
  - read: ./sandbox/lib/python2.7/site-packages/rex.setup_demo-1.0-py2.7.egg-info/rex_static.txt
    ignore: &ignore-prefix |
      /(.*)/sandbox/
  - sh: ls -R ./lib/python2.7/site-packages/rex
    cd: sandbox
  - sh: ls -R ./share/rex
    cd: sandbox
  # Cleanup.
  - rmdir: sandbox

- title: Test `develop` command
  suite: develop
  tests:
  # Create a virtual environment, install rex.setup, prepare rex.setup_demo.
  - *create-virtualenv
  - *install-self
  - *prepare-demo
  # Install rex.setup_demo in editable mode; verify layout and egg-info files.
  - sh: ./bin/pip install -q -e ./src/rex.setup_demo
    cd: sandbox
  - read: ./sandbox/src/rex.setup_demo/src/rex.setup_demo.egg-info/rex_init.txt
  - read: ./sandbox/src/rex.setup_demo/src/rex.setup_demo.egg-info/rex_static.txt
    ignore: *ignore-prefix
  - sh: ls -R ./share/rex
    cd: sandbox
  - sh: ls -R ./share/rex/rex.setup_demo
    cd: sandbox
  # Cleanup.
  - rmdir: sandbox

- title: Test `sdist` command
  suite: sdist
  tests:
  # Create a virtual environment, install rex.setup, prepare rex.setup_demo.
  - *create-virtualenv
  - *install-self
  - *prepare-demo
  # Build source distribution for rex.setup_demo; verify content.
  - sh: ../../bin/python setup.py -q sdist --format=zip
    cd: ./sandbox/src/rex.setup_demo
  - sh: unzip -l ./dist/rex.setup_demo-1.0.zip
    cd: ./sandbox/src/rex.setup_demo
    ignore:
      \d\d\d\d-\d\d-\d\d.\d\d:\d\d |
      ^\s+\d+
  # Cleanup.
  - rmdir: sandbox

